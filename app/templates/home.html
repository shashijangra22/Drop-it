{% extends "base.html" %}
{% block css %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename="homePage.css") }}">
{% endblock %}
{% block content %}
<header>
	<div class="navbar-fixed">
		<nav class="blue">
		    <div class="nav-wrapper">
		      <a href="{{url_for('home')}}" class="brand-logo">Drop it!</a>
		      <a href="#" data-target="mobile-demo" class="sidenav-trigger"><i class="material-icons">menu</i></a>
		      <ul class="right hide-on-med-and-down">
		        <li><a href="{{ url_for('logout') }}">Logout</a></li>
		      </ul>
		    </div>
		  </nav>
	</div>

	<ul class="sidenav sidenav-fixed" id="mobile-demo">
	    <li class="active"><a href="{{ url_for('home') }}"><i style="margin: 0px" class="fas fa-cloud"></i> My Files</a></li>
	    <li><a href="{{ url_for('home') }}"><i style="margin: 0px" class="fas fa-users"></i>Shared With Me</a></li>
	    <li><a href="{{ url_for('home') }}"><i style="margin: 0px" class="fas fa-user"></i>My Profile</a></li>
	    <li><a href="{{ url_for('logout') }}"><i style="margin: 0px" class="fas fa-sign-out-alt"></i>Logout</a></li>
	</ul>
</header>
<main>
	<div>
		<div class="row">
			<div class="col s12">
				<div id="myFilesSection" class="row">
					<h5>Folders</h5>
					<hr>
					<table>
				        <thead>
				          <tr>
				              <th>Name</th>
				              <th>Owner</th>
				              <th>URL</th>
				              <th>Actions</th>
				          </tr>
				        </thead>
				        <tbody>
				        	{% for item in myFiles %}
				        		{% if item.isFile %}
				        		{% else %}
				        			<tr id="{{ item.id }}" class="filePost">
							            <td><a class="openFileBtn" href="{{ item.url }}/{{ item.filename }}"><i class="fas fa-folder"></i> {{ item.filename }}</a></td>
							            <td>{{item.owner.username}}</td>
							            <td>{{item.url}}</td>
							            <td><button class="delBtn">Delete</button></td>
							          </tr>
				        		{% endif %}
				        	{% endfor %}
				        </tbody>
				      </table>
				      <h5>Files</h5>
						<hr>
						<table>
					        <thead>
					          <tr>
					              <th>Name</th>
					              <th>Owner</th>
					              <th>URL</th>
					              <th>Actions</th>
					          </tr>
					        </thead>
					        <tbody>
					        	{% for item in myFiles %}
					        		{%  if item.isFile %}
					        			<tr id="{{ item.id }}" class="filePost">
								            <td><a class="openFileBtn" href="{{ item.url }}/{{ item.filename }}"><i class="fas fa-file"></i> {{ item.filename }}</a></td>
								            <td>{{item.owner.username}}</td>
								            <td>{{item.url}}</td>
								            <td><button class="delBtn">Delete</button><button>Share</button></td>
								          </tr>
					        		{% endif %}
					        	{% endfor %}
					        </tbody>
					      </table>
				</div>
			</div>
		</div>
	</div>
	  <a style="position: fixed;right: 0px;bottom: 0px;margin: 15px" class="btn-floating btn-large waves-effect waves-light blue modal-trigger" href="#uploadModal"><i class="material-icons">add</i></a>
	   <!-- Modal Structure -->
		  <div id="uploadModal" class="modal">
		    <div class="modal-content">
		      <h4>Select files to upload</h4>
		      <form id="uploadForm" enctype="multipart/form-data">
					<input type="file" name="inputFile">
				</form>
		    </div>
		    <div class="modal-footer">
		      <a class="waves-effect waves-green btn-flat" id="uploadBtn">Upload</a>
		    </div>
		  </div>
</main>
{% endblock %}
{% block scripts %}
<script type="text/javascript">

	$(document).ready(function(){
	    $('.sidenav').sidenav();
	    $('.modal').modal();
	  });

		var el=$('main');
		delBtn=el.find('.delBtn');
		shareBtn=el.find('.shareBtn');
		uploadBtn=el.find('#uploadBtn');
		
		delBtn.on('click',deleteFile);
		shareBtn.on('click',shareFile);
		uploadBtn.on('click',uploadFile);
		
		function uploadFile() {
			var form = $('form')[0];
			var formData=new FormData(form);
			formData.append('url', window.location.pathname);
			$.ajax({
				url:'/upload',
				data:formData,
				type:'POST',
				contentType:false,
				processData:false,
				success:function (result) {
					if(result=="1"){
						M.toast({html: "Succesfully uploaded !", displayLength:3000});
						window.location.href=window.location.pathname;
					}
					else{
						M.toast({html: result, displayLength:5000});
					}
				}
			});
		}

		$('uploadForm').submit(function (e) {
			e.preventDefault();
			var form = $('form')[0];
			var formData=new FormData(form);
			formData.append('url', window.location.pathname);
			$.ajax({
				url:'/upload',
				data:formData,
				type:'POST',
				contentType:false,
				processData:false,
				success:function (result) {
					if(result=="1")
						window.location.href=window.location.pathname;
				}
			});
		});

		function shareFile(event) {
			$div=$(this).parent();
			fileID=$div.attr('id');
			username=$div.find('input').val();
			$.ajax({
				url:"/share",
				method:'POST',
				data:{username:username, fileID:fileID},
				success:function (result) {
					console.log(result);
					if(result=="3"){
						window.location.href=window.location.pathname;
					}
				}
			});
		}

		function deleteFile(event) {
			$div=$(this).closest('tr');
			fileID=$div.attr('id');
			$.ajax({
				url:"/deleteFile/"+fileID,
				success: function (result) {
					if(result.length){
						console.log(result);
						$div.fadeOut();
						window.location.href=window.location.pathname;
					}
				}
			});
		}
	</script>
{% endblock %}